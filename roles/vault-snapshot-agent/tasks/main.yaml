---
- name: Prepare directories
  block:
    - name: Create path '{{ vault_snapshot_agent_config_dir }}'
      ansible.builtin.file:
        path: '{{ vault_snapshot_agent_config_dir }}'
        state: directory
        owner: '{{ vault_snapshot_agent_owner }}'
        group: '{{ vault_snapshot_agent_group }}'
        mode: '0755'

- name: Install Vault Snapshot Agent
  block:
    - name: Download binary
      ansible.builtin.get_url:
        url: >
          https://github.com/vertisan/vault-snapshot-agent/releases/download/{{ vault_snapshot_agent_version }}/vault-snapshot-agent_{{ vault_snapshot_agent_version }}_linux_amd64.tar.gz
        dest: "/tmp/vault-snapshot-agent_{{ vault_snapshot_agent_version }}_linux_amd64.tar.gz"
        mode: '0700'
        checksum: "sha256:https://github.com/vertisan/vault-snapshot-agent/releases/download/{{ vault_snapshot_agent_version }}/checksums.txt"

    - name: Unpack Vault Snapshot Agent binary
      ansible.builtin.unarchive:
        src: "/tmp/vault-snapshot-agent_{{ vault_snapshot_agent_version }}_linux_amd64.tar.gz"
        dest: "/usr/bin/"
        remote_src: true
        owner: '{{ vault_snapshot_agent_owner }}'
        group: '{{ vault_snapshot_agent_group }}'
        mode: '0700'

- name: Prepare Vault Snapshot Agent configuration
  ansible.builtin.template:
    src: vault-snapshot-agent.yaml.j2
    dest: '{{ vault_snapshot_agent_config_dir }}/vault-snapshot-agent.yaml'
    owner: '{{ vault_snapshot_agent_owner }}'
    group: '{{ vault_snapshot_agent_group }}'
    mode: '0644'
